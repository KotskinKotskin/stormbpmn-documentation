---
dir:
    order: 5
    link: true
    text: 3. Конфигурация
    collapsible: true
index: true

order: 5
---

[[toc]]

# Конфигурация системы

StormBPMN использует **двухуровневую систему настроек**, которая обеспечивает гибкость конфигурации для различных сценариев развертывания.

::: tip Два уровня настроек
**Уровень 1:** Переменные окружения (ENV) - базовые настройки инфраструктуры
**Уровень 2:** Административная панель - бизнес-логика и функциональность
:::

## Уровень 1: Переменные окружения (ENV)

Переменные окружения настраиваются **до запуска контейнера** и определяют базовую инфраструктуру системы. Эти параметры **требуют перезагрузки** приложения для применения изменений.

| Переменная                 | Описание                        | Пример значения                            | Обязательно  |
| -------------------------- | ------------------------------- | ------------------------------------------ | ------------ |
| **JDBC_URL**               | Строка подключения к PostgreSQL | `jdbc:postgresql://192.168.0.6:5432/storm` | ✅           |
| **JDBC_USERNAME**          | Имя пользователя базы данных    | `stormuser`                                | ✅           |
| **JDBC_PASSWORD**          | Пароль пользователя             | `secure_password_123`                      | ✅           |
| **JAVA_OPTS**              | Настройки памяти для JVM        | `"-Xmx8g"`                                 | ✅           |
| **SPRING_PROFILES_ACTIVE** | Профиль Spring Boot             | `prod`                                     | ✅           |
| **JWTSECRET**              | Соль для шифрования паролей     | Не менее 15 случайных символов             | ✅           |
| **LICENSE_KEY**            | Лицензионный ключ Enterprise    | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`  | ✅           |
| **MINIO_ENDPOINT**         | URL S3-совместимого хранилища   | `http://192.168.0.4:9000`                  | Файлы        |
| **MINIO_ACCESSKEY**        | Ключ доступа к S3               | `stormbpmn-user`                           | Файлы        |
| **MINIO_SECRETKEY**        | Секретный ключ S3               | `secure-password-123`                      | Файлы        |
| **MINIO_DEFAULTBUCKET**    | Бакет по умолчанию              | `storm-uploads`                            | Файлы        |
| **PLANTUML_SERVER**        | URL сервера PlantUML            | `http://192.168.0.5:8090/`                 | Опционально  |
| **GOTENBERG_URL**          | URL сервиса Gotenberg           | `http://192.168.0.5:3001`                  | PDF          |
| **EMAIL_PROVIDER**         | Тип почтового провайдера        | `listmonk` или `smtp`                      | ✅           |
| **LISTMONK_BASE_URL**      | URL API ListMonk                | `http://localhost:9000/api`                | ✅           |
| **LISTMONK_USERNAME**      | Имя API пользователя            | `stormbpmn`                                | ✅           |
| **LISTMONK_PASSWORD**      | API токен                       | `api-token-here`                           | ✅           |
| **AUDIT_ENABLED**          | Включение аудита запросов       | `true`                                     | Безопасность |
| **AUDIT_CHANNEL**          | Канал аудит-логов               | `syslog`                                   | Безопасность |
| **SYSLOG_SERVERS**         | Список syslog серверов          | `localhost:514,192.168.78.53:601`          | Безопасность |
| **SYSLOG_SOURCE**          | Название приложения в логах     | `stormbpmn`                                | Безопасность |

::: warning Важные замечания

-   **PostgreSQL схема:** Для подключения к определенной схеме используйте: `jdbc:postgresql://localhost:5432/mydatabase?currentSchema=myschema`
-   **S3-хранилище:** Без S3 ограничены возможности: нет миниатюр диаграмм, аватаров пользователей и работы с документами
-   **EMAIL_PROVIDER:** Для ListMonk укажите `listmonk`, для простого SMTP - `SMTP`
-   **SMTP настройки:** При использовании простого SMTP дополнительные параметры настраиваются в административной панели

:::

### Легенда обязательности

| Символ       | Значение                                                        |
| ------------ | --------------------------------------------------------------- |
| ✅           | **Обязательно** - система не запустится без этих параметров     |
| Файлы        | **Для файлов** - нужно для работы с документами и изображениями |
| Опционально  | **Опционально** - для дополнительной функциональности           |
| PDF          | **Для PDF** - требуется для генерации документов                |
| Безопасность | **Для безопасности** - нужно для соответствия требованиям ИБ    |

## Уровень 2: Административная панель

Настройки в административной панели управляют **бизнес-логикой** приложения и могут изменяться **без перезагрузки** системы.

::: tip Доступ к админке
Административная панель доступна по адресу: `/app/admin`
Требуются права администратора команды.
:::

### Общие настройки системы

#### Базовые параметры

| Параметр    | Описание                         | Пример значения                 | Обязательно |
| ----------- | -------------------------------- | ------------------------------- | ----------- |
| **baseUrl** | Базовый URL для ссылок в письмах | `https://stormbpmn.company.com` | ✅          |

#### Настройки команд и пользователей

| Параметр                | Описание                                                      | Рекомендация                                |
| ----------------------- | ------------------------------------------------------------- | ------------------------------------------- |
| **enableCommonAssets**  | Общие элементы архитектуры для всех команд                    | ✅ Включить для больших организаций         |
| **enableCommonRoles**   | Общие роли для всех команд                                    | ✅ Включить для унификации                  |
| **enableCommonUsers**   | Общая организационная структура                               | ✅ Включить при централизованном управлении |
| **autoJoinTeamId**      | ID команды для автоматического добавления новых пользователей | Укажите ID основной команды                 |
| **disableTeamPopUp**    | Отключить предложение создать команду                         | ✅ Включить при централизованном управлении |
| **disableTeamCreation** | Запретить создание команд                                     | ✅ Включить при строгом контроле            |

#### Публичный доступ

| Параметр                  | Описание                            | Рекомендация                  |
| ------------------------- | ----------------------------------- | ----------------------------- |
| **allDiagramsAnonAccess** | Анонимный доступ ко всем диаграммам | ❌ Отключить для безопасности |
| **enableAnonSearchPage**  | Поиск для анонимных пользователей   | По требованию бизнеса         |

#### Лицензирование

| Параметр                        | Описание                       | Рекомендация              |
| ------------------------------- | ------------------------------ | ------------------------- |
| **autoEnableEnterpriseLicense** | Автоматическая выдача лицензий | ✅ Включить для упрощения |

### Настройки простого SMTP

::: warning Требуется перезагрузка
Все настройки SMTP применяются **только после перезагрузки** приложения.
:::

| Параметр               | Описание              | Пример значения         |
| ---------------------- | --------------------- | ----------------------- |
| **simpleEmailEnabled** | Включить простой SMTP | `true`                  |
| **simpleSmtpHost**     | SMTP хост             | `smtp.company.com`      |
| **simpleSmtpPort**     | SMTP порт             | `587`                   |
| **simpleSmtpUsername** | SMTP пользователь     | `stormbpmn@company.com` |
| **simpleSmtpPassword** | SMTP пароль           | `secure-password`       |
| **simpleSmtpFrom**     | Email отправителя     | `stormbpmn@company.com` |

### Настройки шаблонов ListMonk

При использовании ListMonk для красивых писем:

| Параметр                               | Тип уведомления                     | Подстановки                                                            |
| -------------------------------------- | ----------------------------------- | ---------------------------------------------------------------------- |
| **commentEmailTemplateId**             | Новый комментарий                   | `{comment_author}`, `{diagram_name}`, `{diagram_url}`, `{html_text}`   |
| **approvalTemplateId**                 | Запрос на согласование              | `{invite_author}`, `{diagram_name}`, `{diagram_url}`                   |
| **restorePasswordTemplateId**          | Восстановление пароля               | `{restoreCode}`                                                        |
| **approvalCompletedTemplateId**        | Согласование завершено              | `{diagram_name}`, `{diagram_url}`                                      |
| **userActivationTemplateId**           | Активация пользователя              | `{activation_token}`                                                   |
| **secureUpdateTemplateId**             | Приглашение к диаграмме             | `{invite_author}`, `{diagram_name}`, `{diagram_url}`                   |
| **inviteDiagramAndRegisterTemplateId** | Приглашение + регистрация           | `{invite_author}`, `{diagram_name}`, `{diagram_url}`, `{register_url}` |
| **teamInviteTemplateId**               | Приглашение в команду               | `{invite_author}`, `{team_name}`                                       |
| **teamInviteAndRegisterTemplateId**    | Приглашение в команду + регистрация | `{invite_author}`, `{team_name}`, `{register_url}`                     |

### Дополнительные настройки

#### Для сложных сетевых конфигураций

| Параметр                     | Описание                                | Пример значения              |
| ---------------------------- | --------------------------------------- | ---------------------------- |
| **gotenbergOverrideBaseUrl** | Прямой адрес для обхода балансировщиков | `http://corp.storm.internal` |

---

## Порядок конфигурации

### 1. Настройка ENV переменных

1. **Обязательные параметры** для запуска:

    ```bash
    JDBC_URL=jdbc:postgresql://db:5432/stormbpmn
    JDBC_USERNAME=stormbpmn_user
    JDBC_PASSWORD=secure_password
    JAVA_OPTS="-Xmx8g"
    SPRING_PROFILES_ACTIVE=prod
    JWTSECRET=your-secret-key-here
    LICENSE_KEY=your-license-key
    ```

2. **Дополнительные сервисы** (по необходимости):

    ```bash
    # S3-хранилище
    MINIO_ENDPOINT=http://minio:9000
    MINIO_ACCESSKEY=stormbpmn-user
    MINIO_SECRETKEY=secure-password

    # Почта
    EMAIL_PROVIDER=listmonk
    LISTMONK_BASE_URL=http://listmonk:9000/api
    LISTMONK_USERNAME=stormbpmn
    LISTMONK_PASSWORD=api-token
    ```

3. **Перезапустите контейнер** для применения изменений

### 2. Настройка через админку

1. **Войдите в административную панель**: `/app/admin`
2. **Настройте базовые параметры**:
    - `baseUrl` - обязательно для корректных ссылок
    - Политики команд и пользователей
3. **Настройте интеграции**:
    - Шаблоны писем (для ListMonk)
    - SMTP параметры (для простой почты)
4. **Сохраните изменения** - применяются мгновенно

---

## Проверка конфигурации

### Проверочный список

-   [ ] **Приложение запускается** без ошибок
-   [ ] **База данных** подключена (есть логи миграций)
-   [ ] **S3-хранилище** работает (видны миниатюры диаграмм)
-   [ ] **Почтовые уведомления** работают (тест: `@email@company.com test`)
-   [ ] **Административная панель** доступна
-   [ ] **Лицензия** активирована

### Распространенные проблемы

| Проблема                  | Причина                     | Решение                                       |
| ------------------------- | --------------------------- | --------------------------------------------- |
| Приложение не запускается | Неверные JDBC параметры     | Проверьте подключение к БД                    |
| Нет миниатюр диаграмм     | Неверные MINIO параметры    | Проверьте доступность S3                      |
| Не приходят письма        | Неверные почтовые настройки | Проверьте EMAIL_PROVIDER и параметры          |
| Ошибки лицензии           | Неверный LICENSE_KEY        | Обратитесь к менеджеру                        |
| Не скачивается PDF        | Ненастроен Gotenberg        | Проверьте GOTENBERG_URL и доступность сервиса |

---

## Связанная документация

-   **[Быстрый старт](../install/GET_STARTED.md)** - минимальная конфигурация
-   **[Production-Ready](../install/FULL_INSTALL.md)** - полная настройка
-   **[Безопасность](../enterprise/security.md)** - SIEM и аудит
-   **[Мониторинг](../support/README.md)** - метрики и алерты

::: tip Нужна помощь?
Если возникли вопросы по конфигурации, обратитесь к **help@stormbpmn.com** или вашему менеджеру.
:::

::: warning Настройка видимости
В административной панели параметр **"Настройка видимости"** разрешает передачу значений на фронтенд. **НЕ включайте** его для паролей и конфиденциальных данных!
:::
