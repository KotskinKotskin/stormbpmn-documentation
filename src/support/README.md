---
dir:
  order: -1
  link: true
  text: Тех.поддержка и администрирование
  collapsible: false
index: true
icon: "handshake-angle"
order: -1
---

# Тех.поддержка и администрирование

В данном разделе описаны варианты поддержки пользователей облачной версии и Enterprise-версии.

Для пользователей Enterprise-версии описаны традиционные задачи технического администрирования системы.

## Каналы поддержки

Мы предоставляем 3 канала поддержки:

- Чат в приложении (кружочек в правой нижней части). Работает только в облачной версии.
- Почта **help@stormbpmn.com** или **storm@bpmn2.ru**.
- Портал [bpmn2.freshdesk.com](https://bpmn2.freshdesk.com). Способ для просмотра ваших заявок и статусов. На портале отдельная регистрация от облачной версии.

### Информация для устранения неисправности

Для быстрого устранения неисправности приложите в свою заявку:

- Версию браузера _(если дело касается пользовательской ошибки)_
- Версию образа контейнера
- [HAR-архив](https://yandex.cloud/ru/docs/support/create-har), записанный в момент неисправности _(если дело касается пользовательской ошибки)_
- Актуальный лог контейнера
- Описание сценария воспроизведения ошибки
- Электронную почту пользователя _(если дело касается пользовательской ошибки)_
- Ссылку на диаграмму _(если дело касается конкретной диаграммы)_

## SLA

| #   | Название                                   | Team          | Enterprise     |
| --- | ------------------------------------------ | --------------- | -------------- |
| 1   | Время реагирования                         | 5 рабочих дней  | 16 часов       |
| 2   | Время устранения критической неисправности | 30 рабочих дней | 15 рабочих дней |

- **Рабочее время**: с 11:00 до 20:00 по МСК (GMT+3), выходные и будни по ТК РФ.
- **Критическая неисправность**: невозможность применять инструмент для 100% пользователей.

Для прочих типов неисправностей SLA для устранения не предоставляется.

::: info
Это SLA по-умолчанию, входящий в базовую поставку лицензий.

Для команд >50 пользователей (облако) или Enterprise он может быть пересмотрен в рамках отдельного соглашения.
:::

## Задачи администрирования

### Мониторинг

Система предоставляет http-endpoint с метриками приложения в формате Micrometer.

Для сбора этих метрик необходимо использовать Prometeus с такой конфигурацией:

```
- job_name: 'storm-1' //повторить для всех нод
    metrics_path: '/actuator/prometheus'
    scrape_interval: 15s
    static_configs:
    - targets: ['10.1.0.3:80'] // ip-адрес сервиса
```

В Endpoint предоставляются базовые метрики spring-приложения, для их визуализации можно использовать вот такой [дашборд](https://grafana.com/grafana/dashboards/12835-spring-boot-statistics-6756-tomcat/).

#### Настройка алертов

Хорошими показателями для реагирования будет:

- СPU usage > 0.90 >5 min
- Request Count /api/v1/* > 100
- HEAP used >0.9 >5
- NO DATA > 5 min

При срабатывании алертов переходите к [Disaster recovery](#disaster-recovery-plan-при-базовои-эксплуатации).

#### Liveness и readiness probe
Система предоставляет liveness и readiness проблы по адресам:

```yml
 livenessProbe:
            httpGet:
              path: /api/health/liveness
              port: 8080
            initialDelaySeconds: 30 
            periodSeconds: 5
 readinessProbe:
            httpGet:
              path: /api/health/readiness
              port: 8080
            initialDelaySeconds: 30 
            periodSeconds: 5
```


### Резверное копирование
Вся ключевая  информация (схемы, описание и т.д.) хранится в базе данных. 

Достаточно обеспечить ее резервное копирование удобными и принятыми инструментами. Например:
```
pg_dump -h localhost XXX -U YYYY -W -Ft -b >/mnt/STORM.tar
```

:::tip
Обеспечьте ежедневное резервное копирование и обеспечьте постоянное свободное место для резервных копий.

Обеспечьте информирование администратора системы информацией об успешных и неуспешных попытках сделать резервную копию.
:::

### Восстановление резервной копии
Восстановите базу данных любым удобным способом, например:

```
pg_restore --format=t -c -N -O -h localhost -p 5432 -U YYYY -d ХХХ /mnt/STORM.tar
```


### Обеспечение высокой доступности
Контейнеры statless. Обеспечить высокую доступность возможно просто развернув второй контейнер приложения и поставив балансер перед двумя контейнерами. 
Возможно использование базовых инструментов k8s.

Пример [конфигурации nginx](https://nginx.org/en/docs/http/load_balancing.html) для 2 контейнеров:
```
upstream storm {
    server 10.0.0.3:80 weight=5 max_conns=500;
    server 10.0.0.4:80 weight=5 max_conns=500;

  }

  location ~ ^/ {
        limit_conn two 30;
        proxy_pass      http://storm;
}
```
Вряд ли вы достигните необходимости масштабировать базу данных, но если потребуется, то вот [хорошая инструкция](https://www.percona.com/blog/setting-up-and-deploying-postgresql-for-high-availability/).

### Обновление версии

1. Определить текущую версию образа контейнера.
2. Ознакомиться с [changelog](https://stormbpmn.changelogfy.com/changelog/en)
3. Определить целевую версию образа контейнера.
4. Выполнить [резервное копирование базы](#резверное-копирование).
5. Скачать целевую версию образа контейнера.
6. Сменить версию образа контейнера на целевую.
7. Дождаться положительных ответов liveness и readiness probe.
8. Обновление выполнено.

При ошибках обновления перейти к [Disaster recovery plan](#disaster-recovery-план-при-обновлении).

::: danger
Обновление между версией <6.3.231 на более высокую требует манипуляции с базой.
Перед обновлением выполните запрос в БД:

```
update databasechangelog set filename = CONCAT('/db/changelog/changes/',SUBSTRING(filename,35))
```
Обновление на версию >=6.6.441 требдует новых ENV переменных:
- STORM_ALLOWED_ORIGINS - установить значение, с которого разрешены сетевые запросы из браузера. Как правило это base_url, что-то типа https://storm.corp.local. Можно установить *(любой домен), но кто вы после этого?
- STORM_DISABLE_SIMPLE_AUTH - установить true \ false. Запрещает базовую авторизацию c емейлом и паролем по базе Stormbpmn.
- STORM_DISABLE_ENV_IN_UI - установить true \ false. Запрещает просмотр ENV-значений в UI администратора.
- STORM_DISABLE_ANON_SHARING - установить true \ false.  запрещает делиться диаграммами анонимно.  Переопределяет настройку enableAnonDiagrams в UI администратора.
- STORM_SENTRY_ENABLE - установить false.
- STORM_ENABLE_SAAS_FEATURES - установить false.

:::

### Disaster recovery plan при обновлении
1. Сохранить логи контейнера.
2. [Восстановить базу](#восстановление-резервнои-копии).
3. Вернуть предидущую версию котнейнера.
5. Перезагрузить контнейнер.
6. Сообщить [информацию](#информация-для-устранения-неисправности) по [каналу поддержки](#каналы-поддержки). Укажите версию, на которую обновиться не вышло и с какой обновлялись.
7. Ожидать решения от поддержки.

### Disaster recovery plan при базовой эксплуатации

1. Сохранить логи контейнера.
2. Перезагрузить контнейнер.
3. Сообщить [информацию](#информация-для-устранения-неисправности) по [каналу поддержки](#каналы-поддержки).
4. Ожидать решения от поддержки.


### Особенности
- Настройте максимальный размер пакетов на балансере в 10MB (директива client_max_body_size для nginx).
- Укажите JAVA_OPTS в ENV контейнера как минимум -Xmx**2**g 
