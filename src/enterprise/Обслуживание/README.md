---
dir:
  order: 4
  link: true
  text: Обсуживание
  collapsible: true
index: true
icon: "handshake-angle"
order: -1
---

# Задачи администрирования

## Мониторинг

Система предоставляет http-endpoint с метриками приложения в формате Micrometer.

Для сбора этих метрик необходимо использовать Prometeus с такой конфигурацией:

```
- job_name: 'storm-1' //повторить для всех нод
    metrics_path: '/actuator/prometheus'
    scrape_interval: 15s
    static_configs:
    - targets: ['10.1.0.3:80'] // ip-адрес сервиса
```

В Endpoint предоставляются базовые метрики spring-приложения, для их визуализации можно использовать вот такой [дашборд](https://grafana.com/grafana/dashboards/12835-spring-boot-statistics-6756-tomcat/).

### Настройка алертов

Хорошими показателями для реагирования будет:

- СPU usage > 0.90 >5 min
- Request Count /api/v1/* > 100
- HEAP used >0.9 >5
- NO DATA > 5 min

При срабатывании алертов переходите к [Disaster recovery](#disaster-recovery-plan-при-базовои-эксплуатации).

### Liveness и readiness probe
Система предоставляет liveness и readiness проблы по адресам:

```yml
 livenessProbe:
            httpGet:
              path: /api/health/liveness
              port: 8080
            initialDelaySeconds: 30 
            periodSeconds: 5
 readinessProbe:
            httpGet:
              path: /api/health/readiness
              port: 8080
            initialDelaySeconds: 30 
            periodSeconds: 5
```


## Резверное копирование
Вся ключевая  информация (схемы, описание и т.д.) хранится в базе данных. 

Достаточно обеспечить ее резервное копирование удобными и принятыми инструментами. Например:
```
pg_dump -h localhost XXX -U YYYY -W -Ft -b >/mnt/STORM.tar
```

:::tip
Обеспечьте ежедневное резервное копирование и обеспечьте постоянное свободное место для резервных копий.

Обеспечьте информирование администратора системы информацией об успешных и неуспешных попытках сделать резервную копию.
:::

## Восстановление резервной копии
Восстановите базу данных любым удобным способом, например:

```
pg_restore --format=t -c -N -O -h localhost -p 5432 -U YYYY -d ХХХ /mnt/STORM.tar
```




## Обновление версии

1. Определить текущую версию образа контейнера.
2. Ознакомиться с [changelog](https://stormbpmn.changelogfy.com/changelog/en)
3. Определить целевую версию образа контейнера.
4. Выполнить [резервное копирование базы](#резверное-копирование).
5. Выполнить ЛОКАЛЬНОЕ сохранение текущего image контейнера.
6. Скачать целевую версию образа контейнера.
7. Сменить версию образа контейнера на целевую.
8. Дождаться положительных ответов liveness и readiness probe.
9. Обновление выполнено.

При ошибках обновления перейти к [Disaster recovery plan](#disaster-recovery-план-при-обновлении).

::: danger
Обновление между версией <6.3.231 на более высокую требует манипуляции с базой.
Перед обновлением выполните запрос в БД:

```
update databasechangelog set filename = CONCAT('/db/changelog/changes/',SUBSTRING(filename,35))
```
Обновление на версию >=6.6.441 требует новых ENV переменных:
- STORM_ALLOWED_ORIGINS - установить значение, с которого разрешены сетевые запросы из браузера. Как правило это base_url, что-то типа https://storm.corp.local. Можно установить *(любой адрес), но кто вы после этого?
- STORM_DISABLE_SIMPLE_AUTH - установить true \ false. Запрещает базовую авторизацию c емейлом и паролем по базе Stormbpmn.
- STORM_DISABLE_ENV_IN_UI - установить true \ false. Запрещает просмотр ENV-значений в UI администратора.
- STORM_DISABLE_ANON_SHARING - установить true \ false.  запрещает делиться диаграммами анонимно.  Переопределяет настройку enableAnonDiagrams в UI администратора.
- STORM_SENTRY_ENABLE - установить false.
- STORM_ENABLE_SAAS_FEATURES - установить false.
- GOTENBERG_URL - ссылка на URL-сервериса конвертации docx в pdf, например. https://demo.gotenberg.dev. Можно вписать что угодно, если не используете конверацию.
- 

Обновление на версию >=6.6.559 требует установки extention базы данных:
```
CREATE EXTENSION IF NOT EXISTS pgcrypto;
```

:::

## Disaster recovery plan при обновлении
1. Сохранить логи контейнера.
2. [Восстановить базу](#восстановление-резервнои-копии).
3. Вернуть предидущую версию котнейнера.
5. Перезагрузить контнейнер.
6. Сообщить [информацию](#информация-для-устранения-неисправности) по [каналу поддержки](#каналы-поддержки). Укажите версию, на которую обновиться не вышло и с какой обновлялись.
7. Ожидать решения от поддержки.

## Disaster recovery plan при базовой эксплуатации

1. Сохранить логи контейнера.
2. Перезагрузить контнейнер.
3. Сообщить [информацию](#информация-для-устранения-неисправности) по [каналу поддержки](#каналы-поддержки).
4. Ожидать решения от поддержки.


## Особенности
- Настройте максимальный размер пакетов на балансере в 10MB (директива client_max_body_size для nginx).
- Укажите JAVA_OPTS в ENV контейнера как минимум -Xmx**2**g 
